
const programs = [
  {
      "name": "Farm Team",
      "parentId": "5d48728aeb91c400017a69b8",
      "oldProducts": ["66a7edca4409a764a4a614e0", "66a7edca4ab7381a6683c20a", "66a7edca4409a764a4a614e2", "66a7edcb5947d02a66c77c9f", "66a7edcb12d4a3603b16f54f", "66a7edcb4ab7381a6683c20c", "66a7edcb4ab7381a6683c20d", "66a7edcb5947d02a66c77ca0", "66a7edcc4409a764a4a614e3", "66a7edcc4ab7381a6683c20f", "66a7edcc5947d02a66c77ca1", "66a7edcc5947d02a66c77ca2", "66a7edcc4409a764a4a614e6", "66a7edcd5947d02a66c77ca3", "66a7edcd4409a764a4a614e7", "66a7edcd12d4a3603b16f551", "66a7edcd5947d02a66c77ca4", "66a7edcd5947d02a66c77ca6", "66a7edcd5947d02a66c77ca7", "66a7edce12d4a3603b16f554", "66a7edce5947d02a66c77ca8", "66a7edce4ab7381a6683c213", "66a7edce5947d02a66c77caa", "66a7edce4409a764a4a614ea", "66a7edcf4409a764a4a614eb", "66a7edcf12d4a3603b16f556", "66a7edcf12d4a3603b16f557",],
      "products": ["66a962ceddc7683266f7c2f7", "66a962d005a0b9179b10cc48", "66a962d0eba91e2534d90f07", "66a962d0eba91e2534d90f08", "66a962d0ddc7683266f7c2f8", "66a962d0eba91e2534d90f09", "66a962d005a0b9179b10cc4a", "66a962d1ddc7683266f7c2f9", "66a962d1ddc7683266f7c2fa", "66a962d1ddc7683266f7c2fb", "66a962d105a0b9179b10cc4b", "66a962cea8c34713d8d6edb6", "66a962d105a0b9179b10cc4c", "66a962d105a0b9179b10cc4d", "66a962d1a8c34713d8d6edb9", "66a962d2eba91e2534d90f0b", "66a962d2eba91e2534d90f0c", "66a962d2a8c34713d8d6edbb", "66a962d2ddc7683266f7c2fd", "66a962d205a0b9179b10cc4f", "66a962cea8c34713d8d6edb7", "66a962cfeba91e2534d90f05", "66a962cf05a0b9179b10cc44", "66a962cfeba91e2534d90f06", "66a962cf05a0b9179b10cc45", "66a962cf05a0b9179b10cc46", "66a962cf05a0b9179b10cc47",],
  },
  {
      "name": "Learn To Race",
      "parentId": "5d48728aeb91c400017a69b6",
      "oldProducts": ["66a7edc74ab7381a6683c204", "66a7edc84409a764a4a614dd", "66a7edc812d4a3603b16f549", "66a7edc812d4a3603b16f54a", "66a7edc85947d02a66c77c99", "66a7edc84ab7381a6683c207", "66a7edc95947d02a66c77c9b", "66a7edc95947d02a66c77c9c", "66a7edc94409a764a4a614de", "66a7edc912d4a3603b16f54c", "66a7edc94ab7381a6683c209", "66a7edca5947d02a66c77c9d", "66a7edca12d4a3603b16f54d"],
      "products": ["66a962cca8c34713d8d6edb3", "66a962cdddc7683266f7c2f6", "66a962ceeba91e2534d90f02", "66a962ceeba91e2534d90f03", "66a962ce05a0b9179b10cc43", "66a962cceba91e2534d90f00", "66a962cc05a0b9179b10cc40", "66a962cd05a0b9179b10cc41", "66a962cdddc7683266f7c2f4", "66a962cdddc7683266f7c2f5", "66a962cdeba91e2534d90f01", "66a962cda8c34713d8d6edb4", "66a962cda8c34713d8d6edb5",]
  },
  {
      "name": "Junior Adventure - Sunday",
      "parentId": "62dae1cb98b31924d39bfb58",
      "oldProducts": ["66a7eaf05947d02a66c77a49", "66a7eaf14ab7381a6683bf9c", "66a7eaf112d4a3603b16f334", "66a7eaf14409a764a4a612b7", "66a7eaf14409a764a4a612b8"],
      "products": ["66a962d6eba91e2534d90f10", "66a962d6a8c34713d8d6edc3", "66a962d605a0b9179b10cc5a", "66a962d6ddc7683266f7c305", "66a962d605a0b9179b10cc5b",]
  },
  {
      "name": "Junior Adventure - Saturday",
      "parentId": "62dae16f106f6c351393a959",
      "products": ["669fed275c2bb33e1246d5cb", "669ff972ed1eb6407a9d4107", "669ff9aca4ab3e7470696eab", "669ff9d7a4ab3e7470696ed4", "669ff9f0ed1eb6407a9d415a",]
  },
  {
      "name": "Women's Locals Program - Sunday",
      "parentId": "5d48728aeb91c400017a69b4",
      "oldProducts": ["66a7edc64ab7381a6683c1ff", "66a7edc64ab7381a6683c200", "66a7edc65947d02a66c77c96", "66a7edc712d4a3603b16f546", "66a7edc74ab7381a6683c202", "66a7edc74ab7381a6683c203", "66a7edc712d4a3603b16f547", "66a7edc712d4a3603b16f548",],
      "products": ["66a962d8ddc7683266f7c309", "66a962d8eba91e2534d90f19", "66a962d905a0b9179b10cc62", "66a962d9ddc7683266f7c30b", "66a962d9ddc7683266f7c30c", "66a962d905a0b9179b10cc63", "66a962d905a0b9179b10cc64", "66a962d9a8c34713d8d6edc6",]
  },
  {
      "name": "Women's Locals Program - Wednesday",
      "parentId": "62fd0e37c704c947d7e8e5d7",
      "oldProducts": ["66a7edc55947d02a66c77c91", "66a7edc55947d02a66c77c92", "66a7edc54ab7381a6683c1fc", "66a7edc55947d02a66c77c93", "66a7edc54409a764a4a614dc", "66a7edc512d4a3603b16f542", "66a7edc65947d02a66c77c94", "66a7edc612d4a3603b16f543",],
      "products": ["66a962d7eba91e2534d90f12", "66a962d7eba91e2534d90f13", "66a962d705a0b9179b10cc5c", "66a962d705a0b9179b10cc5d", "66a962d7eba91e2534d90f15", "66a962d805a0b9179b10cc5e", "66a962d805a0b9179b10cc5f", "66a962d8ddc7683266f7c308",]
  },
  {
      "name": "Program (Saturday Adventure, Mountain Team, AMP)",
      "parentId": "5d48728aeb91c400017a69ae",
      "oldProducts": ["66a7edc15947d02a66c77c89", "66a7edc312d4a3603b16f53d", "66a7edc15947d02a66c77c8a", "66a7edc15947d02a66c77c8b", "66a7edc14409a764a4a614d4", "66a7edc24409a764a4a614d6", "66a7edc24409a764a4a614d9", "66a7edc24409a764a4a614da", "66a7edc25947d02a66c77c8d", "66a7edc25947d02a66c77c8e",],
      "products": ["66a962d2eba91e2534d90f0d", "66a962d4ddc7683266f7c300", "66a962d305a0b9179b10cc50", "66a962d305a0b9179b10cc54", "66a962d3eba91e2534d90f0e", "66a962d3ddc7683266f7c2fe", "66a962d305a0b9179b10cc55", "66a962d3eba91e2534d90f0f", "66a962d3a8c34713d8d6edbe", "66a962d4ddc7683266f7c2ff",]
  },
  {
      "name": "Program (Sunday Adventure, PC Ride, PeeWee)",
      "parentId": "5d48728aeb91c400017a69b2",
      "oldProducts": ["66a7edc35947d02a66c77c8f", "66a7edc44ab7381a6683c1fa", "66a7edc34409a764a4a614db", "66a7edc34ab7381a6683c1f7", "66a7edc312d4a3603b16f53e", "66a7edc412d4a3603b16f53f", "66a7edc44ab7381a6683c1f8", "66a7edc412d4a3603b16f540", "66a7edc412d4a3603b16f541", "66a7edc44ab7381a6683c1f9",],
      "products": ["66a962d4ddc7683266f7c301", "66a962d5ddc7683266f7c303", "66a962d4a8c34713d8d6edc0", "66a962d405a0b9179b10cc56", "66a962d4a8c34713d8d6edc1", "66a962d5ddc7683266f7c302", "66a962d5a8c34713d8d6edc2", "66a962d505a0b9179b10cc57", "66a962d505a0b9179b10cc58", "66a962d505a0b9179b10cc59",]
  }
];

let bundled = {
      cookie : "",
  popupBlock : "",
  url : "https://www.parkcityssbs.com/api/commerce/shopping-cart/entries?crumb=",
  addToCart: function(productIds) {
      this.cookie = this.getCookie("crumb");
  this.url += this.cookie;
  this.popupBlock = document.querySelector("#popup");
  if(productIds){
      productIds.forEach(item => {
          setTimeout(() => { this.apiCall(this.url, item); }, 1000);
      });
  }
},
  apiCall: function (url, id) {
  var input = {itemId: id, sku: null, additionalFields: "null"};
  this.postData(url, input)
    .then(data => view.addMessage(data.newlyAdded.title) )
    .catch(error => console.log('Error:', error));
},
  postData: async function(url , data ) {    
  const response = await fetch(url, {
      method: "POST",
  headers: {"Content-Type" : "application/json" },
  body: JSON.stringify(data),           
  });
  return response.json();
},
  getCookie: function(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
      let c = ca[i];
  while (c.charAt(0) === ' ') {
      c = c.substring(1, c.length);
    }
  if (c.indexOf(nameEQ) === 0) {
      return decodeURIComponent(c.substring(nameEQ.length));
    }
  }
  return null;
},
  popup: function(data) {
   var span = documeent.createElement("span");
  span.innerText = data;
  this.popup.querySelector("div").append(span);
}
}

let view = {
  modal: null,
  content: null,
  init : function() {
  if(this.modal == null) {
      this.modalBox();          
  }
  if(this.content == null) {
      this.contentBox();
  }
},
  addMessage: function(message) {
      this.init();
  const p = document.createElement("p");
  p.innerText = message;
  this.content.append(p);
  this.show();
},
  show: function() {
      this.modal.style.display = "initial";
  setTimeout(() => {view.close(); }, 5000 );
},
  close: function() {
      this.modal.style.display = "none";
},
  modalBox: function() {
      this.modal = document.createElement("div");
  this.modal.id = "popup";
  this.modal.classList.add("modal");
  document.body.append(this.modal); 
},
  contentBox: function() {
      this.content = document.createElement("div");
  this.content.classList.add("modal-content");
  this.modal.append(this.content);
  this.headerBox();
  this.closeButton();
},
  headerBox: function() {
  var h2 = document.createElement("h2");
  h2.innerText = "Products Added";
  this.content.append(h2);
},
  closeButton: function() {
  var button = document.createElement("button");
  button.classList.add("btn-caption");
  button.innerText = "X";
  button.addEventListener("click", function() {view.close(); });
  this.content.append(button);
}
}

var productElements = document.querySelectorAll(".sqs-block-product");
productElements.forEach(element => {
  var rawData = element.querySelectorAll("div")[1].getAttribute("data-current-context");
  var jsonData = JSON.parse(rawData);
  var button = element.querySelector(".sqs-add-to-cart-button");
  button.addEventListener("click" , function() {addProducts(jsonData.id); });
});

function addProducts(itemId) {
  var program = programs.find(p => p.parentId == itemId);
  bundled.addToCart(program.products);
  stopPropagation();
}

function stopPropagation() {
  var elements = document.querySelectorAll(".sqs-block-product");
  elements.forEach(element => {
      element.style.display = "none";
  });
}
